// ResourceViolations.bsh

import java.util.Calendar;
import java.util.GregorianCalendar;
import javax.swing.JInternalFrame;
import org.ops.ui.PSDesktop;
import org.ops.ui.mouse.*;
import org.ops.ui.gantt.*;
import org.ops.ui.chart.*;
import org.ops.ui.util.Util;
import psengine.*;

int month = GregorianCalendar.SEPTEMBER, day = 11; 
GregorianCalendar start = new GregorianCalendar(2006,month,day,0,0);
GregorianCalendar end = new GregorianCalendar(2006,month,day,0,200);

void usingCodeGeneration()
{
	cwd = bsh.cwd;
    psengine.loadModel(cwd+"/libResourceViolations_g.so");
    boolean isFile = true;
    boolean useInterpreter = false;
    psengine.executeTxns(cwd+"/ResourceViolations-initial-state.xml",isFile,useInterpreter);		
}

void usingInterpreter()
{
	cwd = bsh.cwd;
    String nddlModel = cwd+"/ResourceViolations-initial-state.nddl";
    psengine.executeScript("nddl",nddlModel);
}

void initPSEngine()
{
	psengine.setAllowViolations(true);
	//usingCodeGeneration();
	usingInterpreter();
}

void setupDesktop()
    throws Exception
{
    ActionDetailsPanel dp = (ActionDetailsPanel)desktop.makeDetailsFrame().getContentPane().getComponent(0);
    ActionViolationsPanel vp = (ActionViolationsPanel)desktop.makeViolationsFrame().getContentPane().getComponent(0);

    JInternalFrame ganttFrame = desktop.makeResourceGanttFrame("Activity",start,end);
    ganttFrame.setLocation(0,0);
    ganttFrame.setSize(700,300);
    PSGantt gantt = (PSGantt)ganttFrame.getContentPane().getComponent(0);
    gantt.addMouseListener(dp);    
    gantt.addMouseListener(vp);  
    
    desktop.showTokens(psengine.getObjectsByType("CapacityResource").get(0));
}

void showResourceLevels()
{
    resourceFrame = desktop.makeResourcesFrame("CapacityResource",start);
    resourceFrame.setLocation(0,180);
    resourceFrame.setSize(500,300);    	
}

String getBounds(PSToken t)
{
    StringBuffer buf = new StringBuffer();
    
    buf.append(t.getParameter("start"))
       .append("\n ")
       .append(t.getParameter("end"))
       .append("\n");
    
    return buf.toString();
}


initPSEngine();
desktop.makeNddlConsole();
solver = desktop.makeSolver(
    "PlannerConfig.xml" // config
	, 0                 // startHorizon
	, 100               // endHorizon
);

PSVarValue      vv1 ,vv2 ,vv3 ,vv4 ,vv5 ,vv6 ,vv7 ,vv8 ,vv9,
           vv10,vv11,vv12,vv13,vv14,vv15,vv16,vv17,vv18,vv19,
           vv20,vv21,vv22,vv23,vv24,vv25;

void createVarValues()
{
	vv2 = PSVarValue.getInstance(1);
	vv1 = PSVarValue.getInstance(2);
	vv3 = PSVarValue.getInstance(3);
	vv4 = PSVarValue.getInstance(4);
	vv5 = PSVarValue.getInstance(5);
	vv6 = PSVarValue.getInstance(6);
	vv7 = PSVarValue.getInstance(7);
	vv8 = PSVarValue.getInstance(8);
	vv9 = PSVarValue.getInstance(9);
	vv10 = PSVarValue.getInstance(10);
	vv11 = PSVarValue.getInstance(11);
	vv12 = PSVarValue.getInstance(12);
	vv13 = PSVarValue.getInstance(13);
	vv14 = PSVarValue.getInstance(14);
	vv15 = PSVarValue.getInstance(15);
	vv16 = PSVarValue.getInstance(16);
	vv17 = PSVarValue.getInstance(17);
	vv18 = PSVarValue.getInstance(18);
	vv19 = PSVarValue.getInstance(19);
	vv20 = PSVarValue.getInstance(20);
	vv21 = PSVarValue.getInstance(21);
	vv22 = PSVarValue.getInstance(22);
	vv23 = PSVarValue.getInstance(23);
	vv24 = PSVarValue.getInstance(24);
	vv25 = PSVarValue.getInstance(25);
}

PSToken t1,t2,act1,act2,act3;
PSVariable s1,s2,s3;

void findTokens()
{
	res = psengine.getObjectsByType("CapacityResource").get(0);
	t1 = res.getTokens().get(0);
	t2 = res.getTokens().get(1);

	act_obj1 = psengine.getObjectsByType("Activity").get(0);
	act_obj2 = psengine.getObjectsByType("Activity").get(1);
	act_obj3 = psengine.getObjectsByType("Activity").get(2);

	act1 = act_obj1.getTokens().get(0);
	act2 = act_obj2.getTokens().get(0);	
	act3 = act_obj3.getTokens().get(0);	
	s1 = act1.getParameter("start");
	s2 = act2.getParameter("start");
	s3 = act3.getParameter("start");
}

void setStart(PSVarValue a, PSVarValue b, PSVarValue c)
{
	s1.specifyValue(a);
	s2.specifyValue(b);
	s3.specifyValue(c);
	print(psengine.getViolation() + " : " + psengine.getViolationExpl());	
}

desktop.makeSolverDialog(solver);
createVarValues();
//setupDesktop();

/*
to test, run solver, then from the BeanShell listener:

findTokens();
setStart(vv5,vv7,vv6); // Cause Violation
setStart(vv3,vv8,vv14); // Remove Violation
 
*/





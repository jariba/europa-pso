SubDir PLASMA System test ;

if ! $(PLASMA_READY) {

SubInclude PLASMA PlanDatabase test ;
SubInclude PLASMA CBPlanner test ;

ModuleMain all-module-tests : test-main.cc ../../PlanDatabase/test/db-test-module.cc 
                                           ../../Resource/test/rs-test-module.cc 
                                           ../../RulesEngine/test/re-test-module.cc 
                                           ../../RulesEngine/test/TestRule.cc 
                                           ../../ConstraintEngine/test/ConstraintTesting.cc
                                           ../../ConstraintEngine/test/ce-test-module.cc
                                           ../../ConstraintEngine/test/domain-tests.cc
                                           ../../TemporalNetwork/test/TestSubgoalRule.cc
                                           ../../TemporalNetwork/test/tn-test-module.cc
                                           ../../ConstraintEngine/test/ce-test-module.cc
                                           ../../ConstraintEngine/test/ConstraintTesting.cc
                                           ../../Utils/test/util-test-module.cc
                                           ../../CBPlanner/test/cbp-test-module.cc
                                           $(CBPlanner_Test_Files:S=$(SUFOBJ))
                                           : 
                                            System ;
RunModuleMain run-all-module-tests : all-module-tests ;

#
# TRANSACTION TESTS
#

if $(LIBRARIES) = SHARED {
  EXTRA_DEFS = -DSTANDALONE ;
  ModuleNamedObjects runProblem_standalone : runProblem.cc : System ;
  ModuleMain runProblem : runProblem_standalone.o : System ;
}

EXTRA_DEFS = ;
ModuleNamedObjects runProblem_link : runProblem.cc : System ;

local DEFAULT_PCONFIG = "DefaultPlannerConfig.xml" ;

local DEFAULT_HEURISTICS = "../../HeuristicsEngine/test/DefaultHeuristics.xml" ;

# To run one of these individulally: jam run-<target> i.e. jam run-basic-types

local checkin-tests ;
checkin-tests = 
	basic-types
	HTX.1
	HTX.2
	HTX.3
        Rover-transaction
        k9.backtrack.moderate-transaction
        rejection
        resource-backtrack-test
        better-res
        constrain-transaction
        foreach-transaction
        force-object-distribution
        ;

#RunPlannerProblem <model> : <configurationFile> : <heuristicsFile> ;
rule RunPlannerProblem {
  local model = $(1) ;
  local configurationFile = $(2) ;
  local heuristicsFile = $(3) ;
  local exe = $(model:S=) ;
  local hh = $(model:S=.hh) ;
  local cc = [ FGristFiles $(model:S=.cc) ] ;
  local xml = $(model:S=.xml) ;
  local o = $(cc:S=.o) ;
  local lib = $(model:S=) ;

  # create .hh, .cc, .o, and .xml for a .nddl
  Includes $(cc) : $(hh) ;
  NddlCompiler $(hh) $(cc) : $(model) ;
  ModuleObjects $(cc) : NDDL ;
  #ModuleObjects $(cc) : NDDL Aver ;

  # create planner with linked model
  ModuleMain $(exe) : $(o) runProblem_link.o : System Aver ;
  RunModuleMain run-$(exe) : $(exe) : $(xml) $(configurationFile) $(heuristicsFile) ;
  LocalDepends run-nddl-planner-tests : run-$(exe) ;

  Clean clean-system-xml : $(xml) ;

  if $(LIBRARIES) = SHARED {
    # create planner with dlopen model
    ModuleSharedLibrary $(lib) : $(o) : NDDL ;
    local variant ;
    for variant in $(VARIANTS) {
      local libname = [ FModuleSharedLibraryName $(lib) : $(variant) ] ;
      local run_variant_name = [ FVariantName runProblem : $(variant) ] ;
      run_variant_name = $(run_variant_name)_rt ;
      local arguments = $(PWD)$(SLASH)$(SUBDIR)$(SLASH)$(libname) $(xml) $(configurationFile) $(heuristicsFile) ;
      Depends run-problem-$(exe) : $(libname) ;
      RunModuleMain run-problem-$(exe) : runProblem : $(arguments) ;
      Depends RUN_$(run_variant_name).$(arguments:J=.) : $(libname) $(xml) ;
      LocalDepends run-model-tests : run-problem-$(exe) ;
      if $(exe) in $(checkin-tests) {
        LocalDepends run-checkin-tests : run-problem-$(exe) ;
      }
    }
    Depends run-all-tests : run-model-tests ;
  }
}

#
# PLANNER SYSTEM TESTS
#
RunPlannerProblem HTX.1.nddl : $(DEFAULT_PCONFIG) : HTX.1.heur ;
RunPlannerProblem HTX.2.nddl : $(DEFAULT_PCONFIG) : HTX.2.heur ;
RunPlannerProblem HTX.3.nddl : $(DEFAULT_PCONFIG) : HTX.3.heur ;
RunPlannerProblem Rover-transaction.nddl : $(DEFAULT_PCONFIG) : Rover.heur ;
RunPlannerProblem basic-types.nddl : $(DEFAULT_PCONFIG) : $(DEFAULT_HEURISTICS) ;
RunPlannerProblem basic-model-transaction.nddl : $(DEFAULT_PCONFIG) : $(DEFAULT_HEURISTICS) ; 
RunPlannerProblem k9.backtrack.moderate-transaction.nddl : $(DEFAULT_PCONFIG) : k9.heur ;
RunPlannerProblem k9-transaction.nddl : $(DEFAULT_PCONFIG) : $(DEFAULT_HEURISTICS) ;
RunPlannerProblem path-filter-transaction.nddl : $(DEFAULT_PCONFIG) : $(DEFAULT_HEURISTICS) ;
RunPlannerProblem foreach-transaction.nddl : $(DEFAULT_PCONFIG) : $(DEFAULT_HEURISTICS) ;
RunPlannerProblem force-object-distribution.nddl : $(DEFAULT_PCONFIG) : $(DEFAULT_HEURISTICS) ;
RunPlannerProblem resource-backtrack-test.nddl : $(DEFAULT_PCONFIG) : $(DEFAULT_HEURISTICS) ;
RunPlannerProblem rejection.nddl : $(DEFAULT_PCONFIG) : $(DEFAULT_HEURISTICS) ;
RunPlannerProblem constrain-transaction.nddl : $(DEFAULT_PCONFIG) : $(DEFAULT_HEURISTICS) ;
RunPlannerProblem parent-predicate.nddl : $(DEFAULT_PCONFIG) : $(DEFAULT_HEURISTICS) ;
RunPlannerProblem k9-initial.nddl : $(DEFAULT_PCONFIG) : $(DEFAULT_HEURISTICS) ;
RunPlannerProblem backtr.nddl : $(DEFAULT_PCONFIG) : $(DEFAULT_HEURISTICS) ;
RunPlannerProblem better-res.nddl : $(DEFAULT_PCONFIG) : $(DEFAULT_HEURISTICS) ; 
RunPlannerProblem CAPER.nddl : $(DEFAULT_PCONFIG) : $(DEFAULT_HEURISTICS) ;
RunPlannerProblem monkey1monkey-transaction.nddl : $(DEFAULT_PCONFIG) : $(DEFAULT_HEURISTICS) ;
RunPlannerProblem basic-model-backtrack.nddl : $(DEFAULT_PCONFIG) : $(DEFAULT_HEURISTICS) ;
RunPlannerProblem EOS-backtrack-test.nddl : $(DEFAULT_PCONFIG) : $(DEFAULT_HEURISTICS) ;
RunPlannerProblem gnats_2837-tx.nddl : $(DEFAULT_PCONFIG) : $(DEFAULT_HEURISTICS) ;
RunPlannerProblem DynamicObjTest.nddl : $(DEFAULT_PCONFIG) : $(DEFAULT_HEURISTICS) ;
RunPlannerProblem rules.0.tx.nddl : $(DEFAULT_PCONFIG) : $(DEFAULT_HEURISTICS) ;
RunPlannerProblem gnats_2572_interval-tx.nddl : $(DEFAULT_PCONFIG) : $(DEFAULT_HEURISTICS) ;

#
# PERFORMANCE TESTS
#

Main stackGenerator : stackGenerator.cc ;
ObjectHdrs stackGenerator.cc : [ FDirName $(PLASMA) Utils core ] ;
MakeLocate [ FAppendSuffix stackGenerator : $(SUFEXE) ] : $(SUBDIR) ;

rule FSatelliteModel {
  local arguments = $(1) ;
  return satellites-$(arguments:J=-).nddl ;
}

rule GenerateStack {
  local output = $(1) ;
  local generator = $(2) ;
  local arguments = $(3) ;
  Depends $(output) : $(generator) ;
  ARGUMENTS on $(output) = $(arguments) ;
  MakeLocate $(output) : $(SUBDIR) ;
}

actions GenerateStack {
  ./$(2) $(ARGUMENTS) $(1:S=) 
}

local numSatellites ;
#for numSatellites in 1 10 50 100 {
for numSatellites in 1 {
  local numTargets ;
# numTargets == 1 has no plan, so do not add it here.
#  --wedgingt@email.arc.nasa.gov 2004 Dec 10
#  for numTargets in 10 50 100 200 300 400 500 1000 2000 {
#   for numTargets in 10 50 100 1000 {
   for numTargets in 10 50 100 500 {
    local numParams ;
#    for numParams in 0 10 {
     for numParams in 0 {
      local numParamChoices ;
#      for numParamChoices in 0 10 {
       for numParamChoices in 0 {
        if $(numParamChoices) <= $(numParams) {
          local model = [ FSatelliteModel $(numSatellites) $(numTargets) $(numParams) $(numParamChoices) ] ;
          local exe = $(model:S=) ;
          local xml = $(model:S=.xml) ;
          GenerateStack [ FGristFiles $(model) ] : [ FAppendSuffix stackGenerator : $(SUFEXE) ] : $(numSatellites) $(numTargets) $(numParams) $(numParamChoices) ;
          NddlMain $(exe) : runProblem_link.o : $(model) : System CBPlanner : performance-tests ;
          RunModuleMain run-$(exe) : $(exe) : $(xml) $(DEFAULT_PCONFIG) $(DEFAULT_HEURISTICS) : time ;
          LocalDepends run-performance-tests : run-$(exe) ;
        }
      }
    }
  }
}

#
# PLANNER CONTROL TESTS
#
ModuleMain runPlannerControlTest : runPlannerControlTest.cc : : planner-control-tests ;
LinkSharedLibrariesNoDeps runPlannerControlTest_g_rt : $(DLOPEN_LIBRARY) ;


} # PLASMA_READY

#!/bin/sh
# $Id: autobuild,v 1.69 2004-08-24 17:03:52 wedgingt Exp $
#
# Automatically build some variants of the PLASMA planner system

set -x

# Usually, this is run via cron, which does not use the usual $PATH
PATH=/usr/java/j2sdk1.4.2_04/bin:/usr/local/jam2.4:/usr/local/bin:"$PATH"
JAVA_HOME=/usr/java/j2sdk1.4.2_04
export PATH JAVA_HOME

startdir="`dirname $0`"
startdir="`cd $startdir; pwd`"
cd "$startdir"

# Don't run this script more than once in the same directory.
mkdir working || exit 1

trap 'rmdir $startdir/working; rm -f $startdir/.tokens.$$' 0

# Refuse to run if a prior check out is present.
test ! -d PLASMA || exit 2

# Address to mail exit status messages to.
email=checkins@postdoc.arc.nasa.gov

# The (compilation) variants to build and test.
variants='DEV OPTIMIZED PROFILE'

# CVS info
CVS_RSH=ssh
export CVS_RSH
CVSROOT='copernicus.arc.nasa.gov:/home/cvs/ISG-Repository'
export CVSROOT

# Don't try to use X11 (mostly to prevent Purify from doing so)
DISPLAY=
export DISPLAY

# Make sure that libstdc++.so is in this
LD_LIBRARY_PATH='/usr/lib'
export LD_LIBRARY_PATH

# Debug memory allocation; one variant fails in allocation presently here on Slayton
MALLOC_CHECK_=2
export MALLOC_CHECK_

# Apply limits; some compiles run out of swap space.
ulimit -c 300000
ulimit -d 2000000
ulimit -s 2000000
ulimit -v 2000000

# Print the limits so it is obvious what they are when something goes wrong.
ulimit -a

for var in $variants
do

  cvs co PLASMA > cvs.co.PLASMA 2>&1
  status=$?
  echo '"cvs co PLASMA" in '"`pwd`"' exited '"$status"
  if test "$status" != 0
      then
      mkdir PLASMA/cvs.co.failed
      exit "$status"
  fi

  cd PLASMA

  jam -sVARIANTS=$var > jam.output.$var 2>&1
  statusJam=$?
  echo '"jam -sVARIANTS='"$var"'" in '"`pwd`"' exited '"$statusJam"
  if test $statusJam = 0
  then
      jam -sVARIANTS=$var tests > jam.tests.$var 2>&1
      statusJamTests=$?
      echo '"jam -sVARIANTS='"$var"' tests" in '"`pwd`"' exited '"$statusJamTests"
      if test $statusJamTests = 0
      then
          jam -sVARIANTS=$var clean > jam.clean.$var 2>&1
          statusJamClean=$?
          echo '"jam -sVARIANTS='"$var"' tests" in '"`pwd`"' exited '"$statusJamTests"
          if test $statusJamClean = 0
          then
              :
          else
              tail -40 jam.clean.$var
              exit $statusJamClean
          fi
      else
          tail -40 jam.tests.$var
          exit $statusJamTests
      fi
  else
      tail -40 jam.output.$var
      exit $statusJam
  fi

  # Save the jam output files.
  mv -f jam.*.$var ..

  cd ..

  # Remove everything so that each variant is tested completely independently.
  rm -rf PLASMA

done

echo "All builds, tests, and cleans passed for each variant: $variants."

exit 0

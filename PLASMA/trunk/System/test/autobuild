#!/bin/sh
# $Id: autobuild,v 1.71 2004-08-31 17:36:30 wedgingt Exp $
#
# Automatically build some variants of the PLASMA planner system

# set -x

# Usually, this is run via cron, which does not use the usual $PATH
PATH=/usr/java/j2sdk1.4.2_04/bin:/usr/local/jam2.4:/usr/local/bin:"$PATH"
JAVA_HOME=/usr/java/j2sdk1.4.2_04
export PATH JAVA_HOME

startdir="`dirname $0`"
startdir="`cd $startdir; pwd`"
cd "$startdir"

# Don't run this script more than once in the same directory.
mkdir working || exit 1

trap 'rmdir $startdir/working; rm -f $startdir/.tokens.$$' 0

info=`uname -a; echo ''; g++ --version ; hostname ; pwd`

echo "$info"

# Address to mail exit status messages to.
email=checkins@postdoc.arc.nasa.gov

# Refuse to run if a prior check out is present.
if test -d PLASMA
then
    (echo "$info"; echo ''; echo 'PLASMA directory already present, aborting autobuild') | \
        Mail -s 'PLASMA Autobuild on '"`hostname`"' in '"`pwd`"' aborted' "$email"
    exit 2
fi

# The (compilation) variants to build and test.
variants='DEV OPTIMIZED PROFILE'

# CVS info
CVS_RSH=ssh
export CVS_RSH
CVSROOT='copernicus.arc.nasa.gov:/home/cvs/ISG-Repository'
export CVSROOT

# Don't try to use X11 (mostly to prevent Purify from doing so)
DISPLAY=
export DISPLAY

# Make sure that libstdc++.so is in this
LD_LIBRARY_PATH='/usr/lib'
export LD_LIBRARY_PATH

# Debug memory allocation; one variant fails in allocation presently here on Slayton
MALLOC_CHECK_=2
export MALLOC_CHECK_

# Apply limits; some compiles run out of swap space.
ulimit -c 300000
ulimit -d 2000000
ulimit -s 2000000
ulimit -v 2000000

# Print the limits so it is obvious what they are when something goes wrong.
ulimit -a

for var in $variants
do

  cvs co PLASMA > cvs.co.PLASMA 2>&1
  status=$?
  echo '"cvs co PLASMA" in '"`pwd`"' exited '"$status"
  if test "$status" != 0
  then
      mkdir PLASMA/cvs.co.failed
      (echo "$info"; echo ''; echo "'cvs co PLASMA' failed; aborting autobuild"; tail cvs.co.PLASMA) | \
          Mail -s 'PLASMA Autobuild cvs checkout on '"`hostname`"' in '"`pwd`"' failed' "$email"
      exit "$status"
  fi

  cd PLASMA

  jam -sVARIANTS=$var > jam.output.$var 2>&1
  statusJam=$?
  echo '"jam -sVARIANTS='"$var"'" in '"`pwd`"' exited '"$statusJam"
  if test $statusJam = 0
  then
      jam -sVARIANTS=$var tests > jam.tests.$var 2>&1
      statusJamTests=$?
      echo '"jam -sVARIANTS='"$var"' tests" in '"`pwd`"' exited '"$statusJamTests"
      if test $statusJamTests = 0
      then
          jam -sVARIANTS=$var clean > jam.clean.$var 2>&1
          statusJamClean=$?
          echo '"jam -sVARIANTS='"$var"' clean" in '"`pwd`"' exited '"$statusJamClean"
          if test $statusJamClean = 0
          then
              :
          else
              (echo "$info"; echo ''; echo '"jam -sVARIANTS='"$var"' clean" in '"`pwd`"' exited '"$statusJamClean"; tail -40 jam.clean.$var) | \
                  Mail -s 'PLASMA Autobuild jam clean on '"`hostname`"' in '"`pwd`"' failed' "$email"
              exit $statusJamClean
          fi
      else
          (echo "$info"; echo ''; echo '"jam -sVARIANTS='"$var"' tests" in '"`pwd`"' exited '"$statusJamTests"; tail -40 jam.tests.$var) | \
              Mail -s 'PLASMA Autobuild jam tests on '"`hostname`"' in '"`pwd`"' failed' "$email"
          exit $statusJamTests
      fi
  else
      (echo "$info"; echo ''; echo '"jam -sVARIANTS='"$var"'" in '"`pwd`"' exited '"$statusJam"; tail -40 jam.output.$var) | \
          Mail -s 'PLASMA Autobuild jam compile on '"`hostname`"' in '"`pwd`"' failed' "$email"
      exit $statusJam
  fi

  # Save the jam output files.
  mv -f jam.*.$var ..

  cd ..

  # Remove everything so that each variant is tested completely independently.
  rm -rf PLASMA

done

(echo "$info"; echo ''; echo "All builds, tests, and cleans passed for each variant: $variants.") | \
    Mail -s 'PLASMA Autobuild on '"`hostname`"' passed.' "$email"

echo "All builds, tests, and cleans passed for each variant: $variants."

exit 0
